はじめ
前回
記事
4
種類
ストレージ
概要
説明
BLOB
キュー
ファイル
ストレージ
操作
方法
簡単
サンプル
紹介
複雑
処理
ため
仕組み
簡単
実現
こと
前回
本
記事
Web
アプリケーション
例題
テーブル
ストレージ
操作
方法
紹介
本
連載
次
環境
動作
確認
Windows
10
Pro
Visual
Studio
Community
2015
Update
3
以降
VS
2015
Microsoft
Azure
SDK
for
.
NET
(
VS
2015
)
2
.
9
.
6
本稿
説明
リスト
サンプル
中
収録
ご
活用
テーブル
ストレージ
利用
アドレス
帳
Web
アプリケーション
今回
テーブル
ストレージ
データ
保存
Web
アプリケーション
作成
こと
テーブル
ストレージ
アクセス
ため
基本
的
方法
説明
紹介
サンプル
次
よう
登録
フォーム
入力
アドレス
テーブル
ストレージ
保存
画面
登録
すべて
アドレス
情報
閲覧
画面
実装
データ
更新
削除
複雑
条件
検索
次回
紹介
予定
サンプル
プロジェクト
1
回
目
記事
同様
ASP
.
NET
MVC
作成
プロジェクト
作成
時
詳細
設定
情報
そちら
ご覧
実装
クラス
ファイル
サンプル
説明
クラス
ファイル
次
通り
今回
紹介
ファイル
前回
紹介
BLOB
キュー
ファイル
ストレージ
操作
それぞれ
操作
ため
クライアント
対象
クラス
用意
テーブル
ストレージ
同様
クライアント
CloudTableClient
クラス
対象
テーブル
CloudTable
クラス
用意
前回
サンプル
プログラム
中
直接
これら
クラス
操作
本
記事
サンプル
MVC
コントローラ
CloudTable
間
操作
ロジック
ため
クラス
用意
StorageAddressBook
.
cs
ストレージ
テーブル
詳細
処理
コントローラ
隠ぺい
こと
ユニット
テスト
将来
拡張
柔軟
性
確保
よう
設定
ファイル
記述
データ
保存
先
ローカル
PC
開発
環境
の
Azure
本番
環境
の
こと
各
ファイル
内容
確認
データ
クラス
最初
テーブル
ストレージ
保存
ため
必要
クラス
紹介
データ
そのもの
エンティティ
クラス
テーブル
ストレージ
ロジック
実装
クラス
1
件
データ
エンティティ
クラス
テーブル
ストレージ
データ
すべて
TableEntity
継承
クラス
定義
必要
次
クラス
メールアドレス
姓
名
ため
エンティティ
クラス
AddressEntity
.
cs
抜粋
//
1
エンティティ
TableEntity
継承
public
class
AddressEntity
:
TableEntity
{
//
中略
//
2
Email
プロパティ
public
string
Email
{
get
{
return
this
.
RowKey
+
"@"
+
this
.
PartitionKey
;
}
set
{
string
[]
strings
=
value
.
Split
('@');
this
.
RowKey
=
strings
[
0
];
this
.
PartitionKey
=
strings
[
1
];
}
}
//
3
LastName
FirstName
プロパティ
public
string
LastName
{
get
;
set
;
}
public
string
FirstName
{
get
;
set
;
}
}
テーブル
ストレージ
データ
すべて
TableEntity
クラス
継承
必要
1
上記
例
メールアドレス
姓
名
値
それぞれ
Email
LastName
FirstName
名前
string
型
プロパティ
定義
テーブル
ストレージ
場合
指定
プロパティ
PartitionKey
RowKey
存在
今回
PartitionKey
メールアドレス
ドメイン
名
RowKey
ローカル
部
（@
前
部分
使用
こと
2
ため
Email
プロパティ
setter
getter
@
分割
値
それぞれ
キー
結合
テーブル
ストレージ
2
キー
組み合わせ
ユニーク
必要
ため
何
慎重
検討
2
以外
プロパティ
自由
設定
他
プロパティ
定義
3
テーブル
ストレージ
ロジック
実装
クラス
次
テーブル
ストレージ
操作
ため
ロジック
実装
クラス
ストレージ
アドレス
操作
意味
StorageAddressBook
名前
StorageAddressBook
.
cs
抜粋
public
class
StorageAddressBook
{
//
1
CloudTable
インスタンス
参照
private
CloudTable
table
;
public
StorageAddressBook
()
{
//
2
Web
.
config
指定
接続
情報
取得
CloudStorageAccount
storageAccount
=
CloudStorageAccount
.
Parse
(
CloudConfigurationManager
.
GetSetting
("
StorageConnectionString
"));
//
3
テーブルクライアント
作成
CloudTableClient
tableClient
=
storageAccount
.
CreateCloudTableClient
();
//
4
テーブル
参照
取得
存在
場合
作成
table
=
tableClient
.
GetTableReference
("
address
");
table
.
CreateIfNotExists
();
}
}
テーブル
ストレージ
参照
CloudTable
1
度
リクエスト
何
回
アクセス
可能
性
ため
フィールド
保持
1
CloudTable
参照
取得
ため
コンス
トラクタ
次
操作
他
ストレージ
同様
最初
設定
ファイル
記述
接続
情報
取得
2
取得
CloudStorageAccount
インスタンス
テーブルクライアント
作成
3
テーブル
名
指定
対象
テーブル
参照
取得
4
例
address
名前
データ
登録
これ
テーブル
ストレージ
操作
準備
次
データ
登録
処理
ストレージ
データ
登録
テーブル
ストレージ
データ
操作
すべて
テーブル
オペレーション
クラス
使用
実行
挿入
削除
更新
目的
ごと
用意
TableOperation
スタティック
メソッド
エンティティ
対応
オペレーション
インスタンス
作成
CloudTable
#
Execute
()
実行
StorageAddressBook
.
cs
抜粋
public
AddressEntity
Add
(
AddressEntity
entity
)
{
//
1
挿入
オペレーション
作成
実行
TableOperation
insertOperation
=
TableOperation
.
Insert
(
entity
);
TableResult
result
=
table
.
Execute
(
insertOperation
);
//
2
挿入
エンティティ
return
(
AddressEntity
)
result
.
Result
;
}
エンティティ
登録
TableOperation
#
Insert
使用
挿入
オペレーション
作成
CloudTable
#
Execute
()
1
Execute
実行
結果
TableResult
Result
フィールド
設定
エンティティ
2
挿入
結果
エンティティ
更新
日時
システム
付加
情報
エラー
情報
ビューモデル
登録
処理
際
一意
制約
違反
エラー
場合
エンティティ
モデル
情報
以外
エラー
情報
ビュー
よう
ため
複数
データ
ビューモデル
定義
AddressViewModel
.
cs
抜粋
public
class
AddressViewModel
{
//
1
登録
エンティティ
public
AddressEntity
Entity
{
get
;
set
;
}
//
2
エラー
発生
時
例外
public
Exception
Error
{
get
;
set
;
}
}
ビューモデル
登録
エンティティ
1
登録
処理
失敗
場合
エラー
情報
保持
ため
例外
2
2
定義
データ
登録
アクション
エンティティ
登録
アクション
Home
コントローラ
実装
StorageAddressBook
AddressViewModel
クライアント
エンティティ
登録
処理
HomeController
.
cs
抜粋
//
1
エンティティ
クラス
インスタンス
作成
private
StorageAddressBook
addressBook
=
new
StorageAddressBook
();
public
ActionResult
Add
(
AddressViewModel
viewModel
)
{
try
{
//
2
エンティティ
登録
addressBook
.
Add
(
viewModel
.
Entity
);
return
RedirectToAction
("
Index
");
}
catch
(
Exception
e
)
{
//
3
例外
発生
場合
ビューモデル
ビュー
表示
viewModel
.
Error
=
e
;
return
View
(
viewModel
);
}
}
Home
コントローラ
エンティティ
操作
用
StorageAddressBook
コントローラ
作成
時
フィールド
保持
1
Add
アクション
後述
ビュー
ビューモデル
ため
Entity
フィード
保持
エンティティ
StorageAddressBook
#
Add
テーブル
ストレージ
登録
2
登録
成功
場合
一覧
表示
用
アクション
リダイレクト
登録
時
例外
発生
場合
catch
節
Exception
ビューモデル
Error
フィールド
設定
ビュー
描画
データ
登録
ビュー
次
登録
フォーム
表示
ため
ビュー
説明
Add
.
cshtml
抜粋
@*
1
コントローラ
情報
やり取り
ため
ビューモデル
宣言
*@
@
model
AzureTableStorageSample
.
Models
.
AddressViewModel
...
中略
...
@
if
(
Model
!=
null
&&
Model
.
Error
!=
null
)
{
//
2
例外
発生
場合
メッセージ
表示
<
span
class
="
text
-
danger
">@
Model
.
Error
.
Message
)</
span
>
}
@*
3
フォーム
定義
Home
コントローラ
Add
アクション
*@
@
using
(
Html
.
BeginForm
("
Add
",
"
Home
",
new
{
ReturnUrl
=
ViewBag
.
ReturnUrl
},
FormMethod
.
Post
,
new
{
role
=
"
form
"
}))
{
...
中略
...
@*
4
入力
フィールド
ごと
TextBox
用意
*@
@
Html
.
TextBoxFor
(
m
=>
m
.
Entity
.
Email
,
new
{
@
class
=
"
form
-
control
"
})
...
中略
...
@
Html
.
TextBoxFor
(
m
=>
m
.
Entity
.
LastName
,
new
{
@
class
=
"
form
-
control
"
})
...
中略
...
@
Html
.
TextBoxFor
(
m
=>
m
.
Entity
.
FirstName
,
new
{
@
class
=
"
form
-
control
"
})
...
中略
...
<
input
type
="
submit
"
value
="
登録
"
class
="
btn
btn
-
primary
"
/>
}
MVC
標準
的
Form
コンポーネント
利用
登録
必要
定義
最初
ビュー
参照
モデル
宣言
1
エンティティ
エラー
情報
ため
ビューモデル
モデル
使用
登録
時
エラー
発生
場合
よう
原因
ユーザ
ため
ビューモデル
エラー
null
場合
原因
メッセージ
表示
2
Html
.
BeginForm
アクション
情報
表示
定義
3
内部
サーバ
送信
ため
プロパティ
追加
4
データ
一覧
取得
ここ
エンティティ
登録
動作
よう
次
登録
データ
表示
ストレージ
データ
取得
テーブル
ストレージ
データ
取得
TableQuery
クラス
使用
対象
エンティティ
場合
フィルタ
作成
TableQuery
インスタンス
こと
種々
条件
対応
データ
取得
こと
StorageAddressBook
.
cs
抜粋
public
IEnumerable
<
AddressEntity
>
GetAll
()
{
//
1
登録
エンティティ
すべて
取得
return
table
.
ExecuteQuery
(
new
TableQuery
<
AddressEntity
>());
}
本
記事
登録
すべて
エンティティ
取得
方法
検索
条件
指定
場合
条件
単純
取得
エンティティ
型
指定
作成
TableQuery
インスタンス
CloudTable
#
ExecuteQuery
()
1
特定
パラメータ
条件
場合
フィルタ
指定
こと
実現
こと
次回
あたり
説明
予定
データ
取得
アクション
すべて
エンティティ
取得
アクション
上記
説明
メソッド
利用
シンプル
次
よう
記述
こと
HomeController
.
cs
抜粋
public
ActionResult
Index
()
{
//
1
全
データ
取得
var
list
=
addressBook
.
GetAll
();
return
View
(
list
);
}
StorageAddressBook
#
GetAll
()
メソッド
取得
すべて
エンティティ
コレクション
ビュー
結果
表示
データ
一覧
表示
ビュー
最後
一覧
表示
ビュー
定義
Index
.
cshtml
抜粋
@*
1
取得
エンティティ
コレクション
モデル
宣言
*@
@
model
IEnumerable
<
AzureTableStorageSample
.
Models
.
AddressEntity
>
...
中略
...
<
div
>
...
中略
...
@*
2
エンティティ
一つ
表示
*@
@
foreach
(
var
address
in
Model
)
{
<
tr
>
<
td
>@
address
.
Email
</
td
>
<
td
>@
address
.
LastName
</
td
>
<
td
>@
address
.
FirstName
</
td
>
<
td
>@
address
.
Timestamp
</
td
>
</
tr
>
}
...
中略
...
</
div
>
一覧
表示
用
ビュー
モデル
エンティティ
コレクション
ため
これ
モデル
宣言
1
コレクション
@
foreach
一つ
メールアドレス
姓
名
表示
よう
タグ
2
開発
環境
動作
確認
以上
プログラム
紹介
開発
環境
実行
ストレージ
エミュレータ
接続
設定
開発
環境
前回
紹介
ストレージ
エミュレータ
値
保存
こと
前回
App
.
config
ファイル
設定
記述
ASP
.
NET
MVC
プロジェクト
直下
Web
.
config
ファイル
記述
よう
設定
内容
前回
次
よう
設定
Web
.
config
抜粋
<
configuration
>
<
appSettings
>
<
add
key
="
StorageConnectionString
"
value
="
UseDevelopmentStorage
=
true
;"
/>
</
appSettings
>
...
中略
...
</
configuration
>
開発
プログラム
実行
Windows
10
検索
Azure
Storage
Emulator
検索
起動
VS
2015
ソリューション
構成
Debug
指定
Web
アプリケーション
起動
自動的
ブラウザ
最初
何
登録
画面
ここ
追加
画面
メールアドレス
氏名
登録
何
件
登録
一覧
ページ
移動
登録
値
表示
こと
ローカル
環境
ストレージ
保存
内容
確認
VS
2015
サーバーエクスプローラー
利用
サーバーエクスプローラー
ツリー
Azure
－［
ストレージ
－［（
開発
展開
BLOB
キュー
テーブル
登録
データ
内容
確認
こと
サンプル
App
Service
公開
動作
確認
開発
環境
動作
確認
App
Service
公開
世界中
アクセス
よう
App
Service
公開
方法
1
回
目
記事
紹介
やり方
前
Azure
ストレージ
アクセス
ため
設定
必要
アクセス
キー
設定
Azure
ストレージ
データ
保存
アクセス
キー
必要
アクセス
キー
ストレージ
アカウント
前回
記事
御覧
先程
Web
.
config
ファイル
エミュレータ
接続
設定
記述
本番
用
設定
Web
.
Release
.
config
ファイル
記述
設定
次
よう
key
value
以外
属性
値
設定
これ
一致
key
Match
(
key
)）
属性
値
value
Web
.
config
上書き
設定
SetAttributes
操作
指示
ため
もの
Web
.
Release
.
config
<
add
key
="
StorageConnectionString
"
value
="
DefaultEndpointsProtocol
=
https
;
AccountName
=
ストレージ
アカウント
名
;
AccountKey
=
アクセス
キー
"
xdt
:
Transform
="
SetAttributes
"
xdt
:
Locator
="
Match
(
key
)"/>
App
Service
公開
1
回
目
同様
Web
1
クリック
発行
ツールバーボタン
使用
App
Service
公開
開発
環境
よう
アドレス
登録
表示
VS
2015
搭載
Cloud
Explorer
利用
Azure
ストレージ
登録
データ
直接
閲覧
操作
こと
VS
2015
Cloud
Explorer
サブスクリプション
図
従量
課金
）］－［
Storage
Accounts
－［
作成
ストレージ
アカウント
－［
Tables
階層
作成
テーブル
ストレージ
確認
こと
停止
VS
2015
サーバーエクスプローラー
発行
プロファイル
選択
右
クリック
メニュー
停止
選択
まとめ
3
回
目
ストレージ
中
テーブル
ストレージ
具体
的
コード
例
データ
登録
一覧
取得
方法
ASP
.
NET
MVC
使用
Web
アプリケーション
かたち
紹介
Web
アプリケーション
他
更新
削除
処理
必要
機会
次回
それら
CRUD
処理
紹介
予定
WINGS
プロジェクト
花田
善仁
著
/
山田
祥
寛
監修
WINGS
プロジェクト
テクニカル
執筆
プロジェクト
(
代表
山田
祥
寛
)。
海外
記事
翻訳
主
Web
開発
分野
書籍
雑誌
/
Web
記事
執筆
講演
等
一緒
執筆
有志
募集
中
